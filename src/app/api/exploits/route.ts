import { IExploit } from "@/types/exploit.type"
import { createClient } from "@/utils/supabase/server"
import { NextRequest } from "next/server"

export async function GET(request: NextRequest) {
	const supabase = await createClient()

	// get query params
	const params = request.nextUrl.searchParams
	const chainId = params.get('chainId') as string // required
	const limit = params.get('limit')
	const sortBy = params.get('sortBy')
	const ascending = params.get('ascending')

	// validate query
	if (!chainId) return Response.json({
		success: false,
		message: 'chainId param is required'
	}, { status: 400 })

	// retrieve exploits from db
	const query = supabase.from('exploits')
		.select()
		.eq("chain_id", chainId)
		.limit(Number(limit) || 100)

	if (sortBy) query.order(sortBy, {
		ascending: !!ascending
	})

	const { data: exploits, error } = await query.returns<IExploit[]>()

	if (error) return Response.json({
		success: false,
		message: error.message
	}, { status: 500 })

	return Response.json({
		success: true,
		data: exploits
	})
}
